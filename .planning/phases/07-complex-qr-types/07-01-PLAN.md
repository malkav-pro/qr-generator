---
phase: 07-complex-qr-types
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - lib/formatters/vcard.ts
  - components/forms/qr-forms/VCardForm.tsx
  - lib/formatters/index.ts
  - components/forms/qr-forms/index.ts
  - lib/registry.ts
  - components/TypeSelector.tsx
autonomous: true
user_setup: []

must_haves:
  truths:
    - "User can create vCard QR with first name, last name, phone, email, website, company, title, and department"
    - "vCard fields with special characters (semicolons, commas) encode correctly via vcards-js"
    - "Character counter shows vCard size with amber warning at 1400+ and red warning at 1500+ characters"
    - "vCard QR code displays in preview when first and last name are provided"
  artifacts:
    - path: "lib/formatters/vcard.ts"
      provides: "vCard schema + formatter using vcards-js"
      exports: ["vcardSchema", "VCardData", "formatVCard", "getVCardCharacterCount"]
    - path: "components/forms/qr-forms/VCardForm.tsx"
      provides: "8-field vCard form with character counter"
      min_lines: 80
  key_links:
    - from: "components/forms/qr-forms/VCardForm.tsx"
      to: "lib/formatters/vcard.ts"
      via: "import vcardSchema, formatVCard, getVCardCharacterCount"
      pattern: "import.*from.*vcard"
    - from: "lib/formatters/vcard.ts"
      to: "vcards-js"
      via: "vCard generation"
      pattern: "import.*vcards-js|require.*vcards-js"
    - from: "lib/registry.ts"
      to: "components/forms/qr-forms/VCardForm.tsx"
      via: "qrFormRegistry entry"
      pattern: "vcard:.*VCardForm"
---

<objective>
Implement vCard QR code type with multi-field contact form using vcards-js library for RFC 2426-compliant vCard 3.0 generation.

Purpose: Enable users to create scannable contact card QR codes with proper character encoding for iOS/Android camera apps.
Output: VCardForm component, vCard schema+formatter, character counter with warning thresholds, registered in QR type system.
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/07-complex-qr-types/07-RESEARCH.md

# Established patterns from Phase 6
@lib/formatters/wifi.ts
@components/forms/qr-forms/WiFiForm.tsx
@lib/registry.ts
@lib/formatters/index.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Install vcards-js and Create vCard Schema + Formatter</name>
  <files>lib/formatters/vcard.ts, package.json</files>
  <action>
1. Install vcards-js library:
   ```bash
   npm install vcards-js @types/vcards-js
   ```

2. Create `lib/formatters/vcard.ts` with:

   **Schema (vcardSchema):**
   - firstName: required, min 1, max 50 chars
   - lastName: required, min 1, max 50 chars
   - phoneNumber: optional, E.164 format /^\+[1-9]\d{6,14}$/ (reuse WhatsApp pattern)
   - email: optional, email format
   - website: optional, URL format
   - company: optional, max 100 chars
   - title: optional, max 100 chars
   - department: optional, max 100 chars

   **Formatter (formatVCard):**
   - Use vcards-js to generate vCard 3.0 string
   - Set firstName, lastName (required)
   - Conditionally set optional fields only if non-empty: workPhone, email, url, organization, title, role
   - vcards-js handles all RFC 2426 escaping automatically
   - Return vCard.getFormattedString()

   **Character counter helper (getVCardCharacterCount):**
   - Accept Partial<VCardData> for real-time counting during form input
   - For valid complete data: return formatVCard(data).length
   - For incomplete data: estimate using field lengths + 150 overhead
   - Return 0 on error

   **IMPORTANT vcards-js notes:**
   - Import: `import vCardsJS from 'vcards-js';`
   - Initialize: `const vCard = vCardsJS();`
   - vcards-js may have 'fs' module issues in Next.js - getFormattedString() works in browser
   - If import issues, use dynamic import pattern
  </action>
  <verify>
   - `npm ls vcards-js` shows vcards-js@2.10.0+ installed
   - `npx tsc --noEmit` passes without errors
   - Create test vCard in Node REPL: `node -e "const v=require('vcards-js')(); v.firstName='Test'; v.lastName='User'; console.log(v.getFormattedString())"`
  </verify>
  <done>vcardSchema validates multi-field input, formatVCard generates vCard 3.0 string via vcards-js, getVCardCharacterCount provides real-time character count</done>
</task>

<task type="auto">
  <name>Task 2: Create VCardForm Component with Character Counter</name>
  <files>components/forms/qr-forms/VCardForm.tsx</files>
  <action>
Create `components/forms/qr-forms/VCardForm.tsx` following WiFiForm pattern:

1. **Imports:**
   - useForm from react-hook-form
   - zodResolver from @hookform/resolvers/zod
   - useEffect, useMemo from react
   - vcardSchema, VCardData, formatVCard, getVCardCharacterCount from @/lib/formatters/vcard
   - FormFieldSet from ../FormFieldSet

2. **Props type:**
   ```typescript
   type Props = {
     onDataChange: (data: string) => void;
     initialValue?: Partial<VCardData>;
   };
   ```

3. **Form setup:**
   - useForm with zodResolver(vcardSchema), mode: 'onChange'
   - Default values: all fields empty strings, or from initialValue

4. **Character counter logic:**
   ```typescript
   const formData = watch();
   const charCount = useMemo(() => getVCardCharacterCount(formData), [formData]);

   // Warning levels
   const getWarningLevel = (count: number) => {
     if (count >= 1500) return 'critical';  // Red
     if (count >= 1400) return 'warning';   // Amber
     return 'normal';                       // Green/default
   };
   const warningLevel = getWarningLevel(charCount);
   ```

5. **QR update effect:**
   ```typescript
   useEffect(() => {
     const result = vcardSchema.safeParse(formData);
     if (result.success) {
       onDataChange(formatVCard(result.data));
     } else {
       onDataChange('');
     }
   }, [formData, onDataChange]);
   ```

6. **Form fields (8 total):**
   - firstName*: text input, placeholder "John", maxLength 50
   - lastName*: text input, placeholder "Doe", maxLength 50
   - phoneNumber: tel input, placeholder "+12025550172", hint "E.164 format with country code"
   - email: email input, placeholder "john.doe@example.com"
   - website: url input, placeholder "https://example.com"
   - company: text input, placeholder "ACME Corporation", maxLength 100
   - title: text input, placeholder "Software Engineer", maxLength 100
   - department: text input, placeholder "Engineering", maxLength 100

7. **Character counter display:**
   - Show "vCard size: {charCount} characters"
   - At warning level: amber text "Approaching QR code size limit. Consider removing optional fields."
   - At critical level: red text "QR code may be difficult to scan. Remove some optional fields."
   - Use CSS variables for colors: --text-secondary, --warning, --error or similar

8. **Styling:**
   - Match existing form styling from WiFiForm (space-y-4, input classes)
   - Group required fields at top, optional fields below
   - Consider divider or section label between required/optional
  </action>
  <verify>
   - `npx tsc --noEmit` passes
   - `npm run build` succeeds
   - Visually: Form renders 8 fields with proper labels
  </verify>
  <done>VCardForm renders 8 form fields with validation, character counter shows real-time vCard size with color-coded warnings at 1400/1500 char thresholds</done>
</task>

<task type="auto">
  <name>Task 3: Register vCard Type in System</name>
  <files>lib/formatters/index.ts, components/forms/qr-forms/index.ts, lib/registry.ts, components/TypeSelector.tsx</files>
  <action>
1. **Update lib/formatters/index.ts:**
   Add export line:
   ```typescript
   // vCard type
   export { vcardSchema, type VCardData, formatVCard, getVCardCharacterCount } from './vcard';
   ```

   Add 'vcard' to QR_TYPES array:
   ```typescript
   export const QR_TYPES = ['url', 'text', 'email', 'whatsapp', 'wifi', 'vcard'] as const;
   ```

2. **Update components/forms/qr-forms/index.ts:**
   Add export:
   ```typescript
   export { VCardForm } from './VCardForm';
   ```

3. **Update lib/registry.ts:**
   Add import:
   ```typescript
   import { VCardForm } from '@/components/forms/qr-forms/VCardForm';
   ```

   Add to qrFormRegistry:
   ```typescript
   vcard: VCardForm,
   ```

4. **Update components/TypeSelector.tsx:**
   Add label entry to typeLabels:
   ```typescript
   vcard: 'vCard',
   ```
  </action>
  <verify>
   - `npx tsc --noEmit` passes (type system includes vcard)
   - `npm run build` succeeds
   - App runs: vCard appears in type dropdown, form renders when selected, QR preview shows vCard data
  </verify>
  <done>vCard type fully registered: appears in type selector, form loads when selected, valid vCard data generates QR preview</done>
</task>

</tasks>

<verification>
## Overall Plan Verification

1. **Schema + formatter working:**
   - Import vcardSchema in Node/browser console
   - Parse test data: `vcardSchema.safeParse({ firstName: 'John', lastName: 'Doe' })`
   - Format: `formatVCard({ firstName: 'John', lastName: 'Doe', email: 'test@test.com' })`
   - Verify output starts with `BEGIN:VCARD` and ends with `END:VCARD`

2. **Character counter working:**
   - Fill all optional fields with long values
   - Watch character count increase
   - Verify amber warning appears at 1400+ chars
   - Verify red warning appears at 1500+ chars

3. **Full integration:**
   - Select vCard from type dropdown
   - Enter first name and last name
   - Verify QR preview appears
   - Fill optional fields
   - Verify QR updates with each valid change

4. **iOS/Android scan test (manual):**
   - Generate vCard QR with test data
   - Scan with iOS Camera or Android camera
   - Verify contact card appears with correct fields
</verification>

<success_criteria>
- [ ] vcards-js installed and working in Next.js environment
- [ ] vcardSchema validates all 8 fields with proper constraints
- [ ] formatVCard generates RFC 2426 compliant vCard 3.0 strings
- [ ] VCardForm renders 8 fields with proper validation feedback
- [ ] Character counter displays real-time count with warning thresholds
- [ ] vCard type appears in type selector dropdown
- [ ] Selecting vCard loads VCardForm component
- [ ] Valid vCard data generates QR code preview
- [ ] Build passes with no TypeScript errors
</success_criteria>

<output>
After completion, create `.planning/phases/07-complex-qr-types/07-01-SUMMARY.md`
</output>
