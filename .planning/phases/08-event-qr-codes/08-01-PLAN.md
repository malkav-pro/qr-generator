---
phase: 08-event-qr-codes
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - lib/formatters/event.ts
  - lib/formatters/index.ts
  - package.json
  - package-lock.json
autonomous: true

must_haves:
  truths:
    - "Event schema validates title (required), location, description, startDate, endDate, timezone"
    - "Cross-field validation prevents end time before start time"
    - "formatEvent() returns valid iCalendar string with BEGIN:VCALENDAR/END:VCALENDAR"
    - "iCalendar output includes UID, DTSTAMP, DTSTART, DTEND in UTC format"
  artifacts:
    - path: "lib/formatters/event.ts"
      provides: "Event schema, formatter, character counter"
      exports: ["eventSchema", "EventData", "formatEvent", "getEventCharacterCount"]
    - path: "lib/formatters/index.ts"
      provides: "Event type exports and QR_TYPES array update"
      contains: "'event'"
  key_links:
    - from: "lib/formatters/event.ts"
      to: "ics library"
      via: "createEvent import"
      pattern: "import.*ics"
    - from: "lib/formatters/event.ts"
      to: "zod"
      via: "schema definition with refine"
      pattern: "\\.refine\\("
---

<objective>
Create event QR code schema and formatter with iCalendar generation

Purpose: Enable iCalendar-format event QR codes that import correctly across calendar apps
Output: Event schema with cross-field validation, ics library integration, character counter
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/08-event-qr-codes/08-RESEARCH.md

# Prior patterns to follow
@lib/formatters/vcard.ts
@lib/formatters/index.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Install ics and @vvo/tzdb dependencies</name>
  <files>package.json, package-lock.json</files>
  <action>
Install the required dependencies for iCalendar generation and timezone selection:

```bash
npm install ics @vvo/tzdb
```

These libraries are:
- `ics` (v3.8+): Browser-compatible iCalendar/ICS generation, RFC 5545 compliant
- `@vvo/tzdb`: IANA timezone database with friendly names and city references

Note: Do NOT install `timezones-ical-library` - we're using UTC-only approach to avoid VTIMEZONE complexity.
  </action>
  <verify>
Run `npm list ics @vvo/tzdb` to confirm both packages installed.
Run `npm run build` to ensure no dependency conflicts.
  </verify>
  <done>Both ics and @vvo/tzdb appear in package.json dependencies and build succeeds</done>
</task>

<task type="auto">
  <name>Task 2: Create event schema and formatter</name>
  <files>lib/formatters/event.ts</files>
  <action>
Create `lib/formatters/event.ts` following the established co-located schema + formatter pattern.

**Schema fields:**
- `title`: string, required, min 1, max 100 chars
- `location`: string, optional, max 200 chars (use `.optional().or(z.literal(''))` pattern)
- `description`: string, optional, max 500 chars
- `startDate`: string, required, ISO 8601 datetime-local format (YYYY-MM-DDTHH:mm)
- `endDate`: string, required, ISO 8601 datetime-local format
- `timezone`: string, required, IANA format (America/New_York)

**Cross-field validation:**
Use `.refine()` to validate end time is after start time:
```typescript
.refine((data) => new Date(data.startDate) < new Date(data.endDate), {
  message: 'End time must be after start time',
  path: ['endDate'],
})
```

**Formatter function:**
`formatEvent(data: EventData): string` that:
1. Converts local datetime + timezone to UTC for ics library
2. Uses `createEvent` from ics library with `startInputType: 'utc'` and `startOutputType: 'utc'`
3. Generates UID using `crypto.randomUUID()` (native browser API)
4. Returns iCalendar string

**Character counter:**
`getEventCharacterCount(data: Partial<EventData>): number` following vcard.ts pattern:
- Return exact count for valid complete data
- Return estimate for incomplete data (200 base overhead + field lengths)

**Important implementation notes:**
- Use UTC-only times (no VTIMEZONE components) per research recommendation
- The ics library createEvent returns `{ error, value }` - handle errors appropriately
- Array format for dates: `[year, month, day, hour, minute]` where month is 1-12 (not 0-11)
  </action>
  <verify>
Create a test in terminal:
```typescript
import { eventSchema, formatEvent } from './lib/formatters/event';
const testData = {
  title: 'Test Meeting',
  location: 'Room A',
  description: 'Planning session',
  startDate: '2026-02-15T14:30',
  endDate: '2026-02-15T15:30',
  timezone: 'America/New_York'
};
console.log(eventSchema.safeParse(testData));
console.log(formatEvent(testData));
```
Output should show valid parse result and iCalendar string with BEGIN:VCALENDAR, VEVENT, UID, DTSTAMP, DTSTART/DTEND with Z suffix.
  </verify>
  <done>
- eventSchema validates all 6 fields with cross-field date validation
- formatEvent returns valid iCalendar with UTC timestamps
- getEventCharacterCount provides accurate size estimation
  </done>
</task>

<task type="auto">
  <name>Task 3: Export event type from formatters index</name>
  <files>lib/formatters/index.ts</files>
  <action>
Update `lib/formatters/index.ts` to export the event formatter:

1. Add export line:
```typescript
// Event type
export { eventSchema, type EventData, formatEvent, getEventCharacterCount } from './event';
```

2. Add 'event' to QR_TYPES array:
```typescript
export const QR_TYPES = ['url', 'text', 'email', 'whatsapp', 'wifi', 'vcard', 'telegram', 'event'] as const;
```

Follow the existing pattern - exports grouped by type with comments.
  </action>
  <verify>
Run TypeScript compilation: `npx tsc --noEmit`
Import test: `import { eventSchema, formatEvent, QR_TYPES } from '@/lib/formatters'` should work.
QR_TYPES should now include 'event' (8 types total).
  </verify>
  <done>Event exports available from lib/formatters, QR_TYPES includes 'event'</done>
</task>

</tasks>

<verification>
After all tasks complete:
1. `npm run build` succeeds with no errors
2. `eventSchema.safeParse()` validates complete event data correctly
3. `eventSchema.safeParse()` rejects end time before start time with error on endDate field
4. `formatEvent()` returns string starting with `BEGIN:VCALENDAR` and ending with `END:VCALENDAR`
5. Output contains `DTSTART:` and `DTEND:` with `Z` suffix (UTC format)
6. Output contains `UID:` with UUID v4 format
</verification>

<success_criteria>
- ics and @vvo/tzdb dependencies installed and build passes
- Event schema validates title (required), location/description (optional), start/end dates, timezone
- Cross-field validation prevents end before start with error displayed on endDate field
- formatEvent generates valid iCalendar with UTC timestamps (Z suffix)
- iCalendar output includes all required fields: UID, DTSTAMP, DTSTART, DTEND, SUMMARY
- Character counter estimates event size for QR scannability warnings
</success_criteria>

<output>
After completion, create `.planning/phases/08-event-qr-codes/08-01-SUMMARY.md`
</output>
