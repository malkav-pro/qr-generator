---
phase: 06-simple-qr-types
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - lib/formatters/whatsapp.ts
  - components/forms/qr-forms/WhatsAppForm.tsx
  - lib/formatters/index.ts
  - components/forms/qr-forms/index.ts
  - lib/registry.ts
  - components/TypeSelector.tsx
autonomous: true

must_haves:
  truths:
    - "User can enter phone number with country code"
    - "User can enter optional pre-filled message"
    - "System validates phone to E.164 format"
    - "System generates wa.me/{number}?text={message} URL"
  artifacts:
    - path: "lib/formatters/whatsapp.ts"
      provides: "WhatsApp schema and formatter"
      exports: ["whatsappSchema", "WhatsAppData", "formatWhatsApp"]
    - path: "components/forms/qr-forms/WhatsAppForm.tsx"
      provides: "WhatsApp form component"
      exports: ["WhatsAppForm"]
  key_links:
    - from: "WhatsAppForm.tsx"
      to: "whatsapp.ts"
      via: "zodResolver(whatsappSchema)"
      pattern: "zodResolver.*whatsappSchema"
    - from: "lib/registry.ts"
      to: "WhatsAppForm"
      via: "qrFormRegistry"
      pattern: "whatsapp:\\s*WhatsAppForm"
    - from: "lib/formatters/index.ts"
      to: "whatsapp.ts"
      via: "QR_TYPES constant"
      pattern: "'whatsapp'"
---

<objective>
Implement WhatsApp QR code type with E.164 phone validation and wa.me URL formatting.

Purpose: Enable users to create WhatsApp click-to-chat QR codes with validated phone numbers and optional pre-filled messages.
Output: Working WhatsApp QR type selectable from TypeSelector, generating scannable wa.me URLs.
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/06-simple-qr-types/06-RESEARCH.md

# Existing patterns to follow
@lib/formatters/email.ts
@components/forms/qr-forms/EmailForm.tsx
@lib/formatters/index.ts
@lib/registry.ts
@components/TypeSelector.tsx
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create WhatsApp Schema and Formatter</name>
  <files>lib/formatters/whatsapp.ts</files>
  <action>
Create `lib/formatters/whatsapp.ts` following the email.ts pattern:

1. Define whatsappSchema with Zod:
   - `phoneNumber`: string, required, validated with E.164 regex `/^\+[1-9]\d{6,14}$/`
     - Error messages: "Phone number is required", "Must be valid E.164 format (e.g., +12025550172)"
   - `message`: string, optional, max 500 characters
     - Error message: "Message must be 500 characters or less"

2. Export `WhatsAppData` type inferred from schema

3. Implement `formatWhatsApp(data: WhatsAppData): string`:
   - Strip + prefix from phone: `phoneNumber.replace(/^\+/, '')`
   - Build wa.me URL: `https://wa.me/${cleanPhone}`
   - If message exists and not empty, append: `?text=${encodeURIComponent(message)}`
   - Return full URL

CRITICAL: Do NOT URL-encode the phone number or the base URL. Only encode the message parameter.
CRITICAL: Use [1-9] after + in regex, NOT [0-9]. Country codes never start with 0.
  </action>
  <verify>
Create test file and run:
```typescript
import { whatsappSchema, formatWhatsApp } from './whatsapp';

// Valid cases
console.log(whatsappSchema.safeParse({ phoneNumber: '+12025550172' }).success); // true
console.log(whatsappSchema.safeParse({ phoneNumber: '+12025550172', message: 'Hello!' }).success); // true

// Invalid cases
console.log(whatsappSchema.safeParse({ phoneNumber: '12025550172' }).success); // false (no +)
console.log(whatsappSchema.safeParse({ phoneNumber: '+0123456789' }).success); // false (starts with 0)
console.log(whatsappSchema.safeParse({ phoneNumber: '' }).success); // false (required)

// Format output
console.log(formatWhatsApp({ phoneNumber: '+12025550172', message: '' }));
// https://wa.me/12025550172

console.log(formatWhatsApp({ phoneNumber: '+12025550172', message: 'Hello World!' }));
// https://wa.me/12025550172?text=Hello%20World!
```
  </verify>
  <done>whatsappSchema validates E.164 format correctly; formatWhatsApp generates valid wa.me URLs</done>
</task>

<task type="auto">
  <name>Task 2: Create WhatsApp Form Component</name>
  <files>components/forms/qr-forms/WhatsAppForm.tsx</files>
  <action>
Create `components/forms/qr-forms/WhatsAppForm.tsx` following EmailForm.tsx pattern:

1. Import useForm, zodResolver, useEffect from react-hook-form
2. Import whatsappSchema, WhatsAppData, formatWhatsApp from @/lib/formatters
3. Import FormFieldSet from '../FormFieldSet'

4. Props type:
```typescript
type Props = {
  onDataChange: (data: string) => void;
  initialValue?: { phoneNumber?: string; message?: string };
};
```

5. useForm setup:
   - resolver: zodResolver(whatsappSchema)
   - mode: 'onBlur'
   - defaultValues: phoneNumber from initialValue or '', message from initialValue or ''

6. Watch form data and update QR on valid changes:
   - Use watch() to get formData
   - In useEffect, check if phoneNumber has value
   - Use whatsappSchema.safeParse(formData)
   - If valid, call onDataChange(formatWhatsApp(result.data))
   - If invalid but phoneNumber exists, call onDataChange('') to clear preview

7. Render two FormFieldSet components:
   - Phone Number field:
     - name="phoneNumber"
     - label="Phone Number"
     - input type="tel"
     - placeholder="+12025550172"
     - Hint text below: "Include country code (e.g., +1 for USA, +44 for UK)"

   - Message field:
     - name="message"
     - label="Pre-filled Message"
     - optional={true}
     - textarea with rows={4}
     - placeholder="Hello! I'd like to chat..."
     - Character counter hint: "{length}/500 characters"

Use same Tailwind classes as EmailForm.tsx for consistency.
  </action>
  <verify>
Run dev server: `npm run dev`
Navigate to app, verify WhatsApp option not yet visible (registry not updated)
Check file compiles without TypeScript errors: `npx tsc --noEmit`
  </verify>
  <done>WhatsAppForm component created with phone and message fields, FormFieldSet integration, and watch-based QR updates</done>
</task>

<task type="auto">
  <name>Task 3: Register WhatsApp Type in System</name>
  <files>
lib/formatters/index.ts
components/forms/qr-forms/index.ts
lib/registry.ts
components/TypeSelector.tsx
  </files>
  <action>
Update four files to register the WhatsApp type:

1. **lib/formatters/index.ts** - Add export and extend QR_TYPES:
```typescript
// WhatsApp type
export { whatsappSchema, type WhatsAppData, formatWhatsApp } from './whatsapp';

// Update QR_TYPES to include 'whatsapp'
export const QR_TYPES = ['url', 'text', 'email', 'whatsapp'] as const;
```

2. **components/forms/qr-forms/index.ts** - Add export:
```typescript
export { WhatsAppForm } from './WhatsAppForm';
```

3. **lib/registry.ts** - Add to registry:
- Import WhatsAppForm from @/components/forms/qr-forms/WhatsAppForm
- Add to qrFormRegistry: `whatsapp: WhatsAppForm`

4. **components/TypeSelector.tsx** - Add label:
- Add to typeLabels: `whatsapp: 'WhatsApp'`

Order in QR_TYPES should be: url, text, email, whatsapp (logical grouping: basic types first, then messaging)
  </action>
  <verify>
Run dev server: `npm run dev`
Navigate to app at localhost:3000
Verify: "WhatsApp" button appears in TypeSelector
Click WhatsApp: form shows Phone Number and Message fields
Enter valid phone (+12025550172): QR code preview updates
Enter invalid phone (12025550172): validation error shows
Add message "Hello!": QR code updates with encoded message
Scan QR with phone camera: should open WhatsApp chat to that number
  </verify>
  <done>WhatsApp type fully integrated - selectable in UI, form renders, QR generates valid wa.me URLs</done>
</task>

</tasks>

<verification>
1. TypeScript compiles: `npx tsc --noEmit` passes
2. Dev server runs: `npm run dev` starts without errors
3. WhatsApp selectable in TypeSelector (4 buttons: URL, Text, Email, WhatsApp)
4. WhatsApp form validates:
   - Empty phone shows "Phone number is required"
   - Invalid format (+0123...) shows "Must be valid E.164 format"
   - Valid phone (+12025550172) clears errors
5. QR preview updates on valid phone input
6. Message character counter shows current length
7. Generated QR encodes wa.me URL correctly
</verification>

<success_criteria>
- WHATSAPP-01: User can enter phone number - phone input field works
- WHATSAPP-02: User can enter optional message - message textarea works with counter
- WHATSAPP-03: E.164 validation - regex validates +[1-9]\d{6,14} format
- WHATSAPP-04: wa.me URL generation - formatWhatsApp produces correct URLs
</success_criteria>

<output>
After completion, create `.planning/phases/06-simple-qr-types/06-01-SUMMARY.md`
</output>
